<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BVG Echtzeit – Hahneberg & Reimerweg</title>
<meta name="color-scheme" content="dark light"/>
<style>
  :root{--bvg:#ffd200;--bg:#000;--fg:#ffd200;--muted:#8ea0b2;--panel:#0b1016;--border:#1a1f27;--accent:#00c8ff}
  *{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
  .wrap{max-width:980px;margin:0 auto;padding:12px}
  .head{display:flex;justify-content:space-between;align-items:center;padding:6px 8px 2px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:36px;height:36px;border-radius:6px;background:var(--bvg);color:#000;display:grid;place-items:center;font-weight:900}
  .right{display:flex;gap:12px;align-items:center}
  .badge{background:var(--accent);color:#00121a;border-radius:999px;padding:4px 10px;font-weight:800;font-size:12px}
  .small{color:var(--muted);font-size:12px}
  .seg{display:flex;gap:8px;margin:8px 8px 0}
  .seg button{background:#0a0e12;color:var(--fg);border:1px solid #171c22;border-radius:12px;padding:8px 12px;cursor:pointer}
  .seg button.active{background:var(--accent);color:#00121a;border:none}
  .hdr{display:grid;grid-template-columns:120px 1fr 140px;align-items:end;color:var(--muted);padding:6px 10px;font-size:14px;border-bottom:1px solid var(--border)}
  .list{margin-top:6px}
  .row{display:grid;grid-template-columns:120px 1fr 140px;align-items:center;height:48px;padding:0 10px;margin-top:8px;border-radius:14px;background:var(--panel)}
  .lincol{display:flex;gap:10px;align-items:center}
  .badgeLine{min-width:74px;height:34px;padding:0 12px;border-radius:9px;background:var(--bvg);color:#000;font-weight:900;display:inline-flex;align-items:center;justify-content:center;font-size:22px}
  .dir{position:relative;overflow:hidden;height:1.4em}
  .tickerInner{white-space:nowrap;display:inline-block}
  .mins{justify-self:end;font-weight:900;font-size:28px}
  .unit{font-size:14px;color:var(--muted);margin-left:6px}
  .info{color:var(--muted);margin:10px 10px 0}
  .err{color:#ff6b6b;margin:10px 10px 0;display:none}
  .ghost{opacity:.65}
  footer{margin-top:12px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <div class="brand"><div class="logo">BVG</div><div style="font-weight:900">Echtzeit-Anzeige</div></div>
    <div class="right"><span id="status" class="small">lädt…</span><span id="badge" class="badge">30s</span></div>
  </div>

  <!-- Stationen -->
  <div class="seg" aria-label="Stationen">
    <button id="tHah" class="active">Hahneberg (M37/M49)</button>
    <button id="tRei">Reimerweg (M137)</button>
  </div>

  <!-- Modus -->
  <div class="seg" aria-label="Modus">
    <button id="tDep" class="active">Abfahrten</button>
    <button id="tArr">Ankünfte</button>
  </div>

  <div class="hdr"><div>Linie</div><div>Ziel</div><div id="thWhen" style="text-align:right">Abfahrt</div></div>

  <div id="list" class="list"></div>
  <div id="info" class="info"></div>
  <div id="err" class="err" role="alert" aria-live="assertive"></div>
  <footer>Ziel läuft bei Überlänge automatisch durch. • <span id="clock"></span></footer>
</div>

<script>
(function(){
  // IDs
  var STOP_HAHNEBERG = '900037203';
  var STOP_REIMERWEG = '900000037274';
  var API = 'https://v6.vbb.transport.rest';

  // DOM
  var listEl=document.getElementById('list'), infoEl=document.getElementById('info'),
      errEl=document.getElementById('err'), statusEl=document.getElementById('status'),
      badgeEl=document.getElementById('badge'), clockEl=document.getElementById('clock'),
      thWhen=document.getElementById('thWhen');
  var tHah=document.getElementById('tHah'), tRei=document.getElementById('tRei'),
      tDep=document.getElementById('tDep'), tArr=document.getElementById('tArr');

  // State
  var stopMode='hahneberg';   // 'hahneberg' | 'reimerweg'
  var endpoint='departures';  // 'departures' | 'arrivals'
  var lineSet={'M37':1,'37':1,'M49':1,'49':1}; // default: Hahneberg

  // Uhr
  function tick(){ clockEl.textContent=new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
  setInterval(tick,1000); tick();

  // URL je Station
  function urlFor(mode){
    var path=(mode==='arrivals')?'arrivals':'departures';
    if (stopMode==='hahneberg'){
      // Hahneberg funktioniert zuverlässig über /stops
      return API + '/stops/' + encodeURIComponent(STOP_HAHNEBERG) + '/' + path + '?duration=180&results=120&language=de&remarks=false';
    } else {
      // Reimerweg braucht /stations
      return API + '/stations/' + encodeURIComponent(STOP_REIMERWEG) + '/' + path + '?duration=180&results=120&language=de&remarks=false';
    }
  }

  // Helpers
  function minutesLeft(iso){ var m=Math.round((new Date(iso).getTime()-Date.now())/60000); return (m<0?0:m); }
  function setStatus(code, kind){ // kind: 'ok' | 'hint' | 'err'
    var suffix = kind==='hint' ? ' • Hinweis' : (kind==='err' ? ' • Fehler' : '');
    statusEl.textContent = 'HTTP ' + code + suffix;
  }
  function setTabs(){
    tHah.classList.toggle('active', stopMode==='hahneberg');
    tRei.classList.toggle('active', stopMode==='reimerweg');
    tDep.classList.toggle('active', endpoint==='departures');
    tArr.classList.toggle('active', endpoint==='arrivals');
    thWhen.textContent = endpoint==='arrivals' ? 'Ankunft' : 'Abfahrt';
  }

  function row(it){
    var line=(it&&it.line&&it.line.name)?String(it.line.name):'?';
    var dir =(it&&it.direction)?String(it.direction):(it&&it.destination&&it.destination.name)?String(it.destination.name):'—';
    var when=(it&&(it.plannedWhen||it.when))?(it.plannedWhen||it.when):null;

    var r=document.createElement('div'); r.className='row';
    var lin=document.createElement('div'); lin.className='lincol';
    var b=document.createElement('div'); b.className='badgeLine'; b.textContent=line; lin.appendChild(b);

    var w=document.createElement('div'); w.className='dir';
    var inner=document.createElement('div'); inner.className='tickerInner'; inner.textContent=dir.replace(/^Berlin,\s*/,'').trim(); w.appendChild(inner);

    var m=document.createElement('div'); m.className='mins'; m.innerHTML=when? (minutesLeft(when)+'<span class="unit">min</span>') : '–';

    r.appendChild(lin); r.appendChild(w); r.appendChild(m);

    // einfacher Marquee
    setTimeout(function(){
      var wc=w.clientWidth, wi=inner.scrollWidth;
      if(wi>wc){
        var gap=60, txt=inner.textContent, total=wi+gap, dur=Math.max(8,Math.round(total/60));
        inner.innerHTML='<span>'+txt+'</span><span style="padding-left:'+gap+'px">'+txt+'</span>';
        var key='mq_'+Math.random().toString(36).slice(2);
        var st=document.createElement('style');
        st.textContent='@keyframes '+key+'{0%{transform:translateX(0)}100%{transform:translateX(-'+total+'px)}}';
        document.head.appendChild(st);
        inner.style.animation=key+' '+dur+'s linear infinite';
      }
    },0);

    return r;
  }

  function render(list, message){
    listEl.innerHTML=''; infoEl.textContent=''; errEl.style.display='none';
    if(message==='no-arrivals'){
      var rr=document.createElement('div'); rr.className='row'; rr.style.justifyContent='center';
      rr.innerHTML='<div style="grid-column:1/4;text-align:center;font-weight:900">Für diese Haltestelle stellt die BVG keine Ankunftsdaten bereit.</div>';
      listEl.appendChild(rr); return;
    }
    if(!list||!list.length){
      var r=document.createElement('div'); r.className='row'; r.style.justifyContent='center';
      r.innerHTML='<div style="grid-column:1/4;text-align:center;font-weight:900">Keine Daten</div>';
      listEl.appendChild(r); return;
    }
    for(var i=0;i<list.length&&i<18;i++) listEl.appendChild(row(list[i]));
  }

  function filterByLines(list){
    var out=[], i, nm;
    for(i=0;i<list.length;i++){
      nm = (list[i]&&list[i].line&&list[i].line.name)? String(list[i].line.name).toUpperCase() : '';
      if(lineSet[nm]) out.push(list[i]);
    }
    return out;
  }

  // Auto-Refresh
  var timerR=null,timerC=null,cd=30;
  function startAuto(){
    if(timerR) clearInterval(timerR);
    if(timerC) clearInterval(timerC);
    cd=30; badgeEl.textContent=cd+'s';
    timerC=setInterval(function(){ cd--; if(cd<0) cd=30; badgeEl.textContent=cd+'s'; },1000);
    timerR=setInterval(function(){ cd=30; load(); },30000);
  }

  async function load(){
    try{
      errEl.style.display='none';
      listEl.innerHTML='<div class="row" style="justify-content:center"><div style="grid-column:1/4" class="ghost">Lade Daten…</div></div>';

      var url=urlFor(endpoint);
      var res=await fetch(url, {cache:'no-store', headers:{accept:'application/json'}});
      if(!res.ok){
        // Option C: 404 bei Arrivals → neutraler Hinweis statt Fehler
        if(res.status===404 && endpoint==='arrivals'){
          setStatus(404,'hint'); render(null,'no-arrivals'); return;
        }
        setStatus(res.status,'err');
        var t=await res.text();
        errEl.textContent='Fehler: HTTP '+res.status+' • '+t.slice(0,120)+'…';
        errEl.style.display='block'; render([]); return;
      }
      setStatus(200,'ok');
      var data=await res.json();
      var list=Array.isArray(data)?data:(data[endpoint]||[]);
      list = filterByLines(list).sort(function(a,b){
        var aw=(a&&(a.when||a.plannedWhen))?new Date(a.when||a.plannedWhen).getTime():0;
        var bw=(b&&(b.when||b.plannedWhen))?new Date(b.when||b.plannedWhen).getTime():0;
        return aw-bw;
      });
      render(list);
    }catch(e){
      setStatus('—','err'); errEl.textContent='Netzwerkfehler: '+(e&&e.message?e.message:String(e));
      errEl.style.display='block'; render([]);
    }finally{
      startAuto();
    }
  }

  // Tab-Events
  tHah.onclick=function(){
    stopMode='hahneberg';
    lineSet={'M37':1,'37':1,'M49':1,'49':1};
    setTabs(); load();
  };
  tRei.onclick=function(){
    stopMode='reimerweg';
    lineSet={'M137':1,'137':1};
    setTabs(); load();
  };
  tDep.onclick=function(){ endpoint='departures'; setTabs(); load(); };
  tArr.onclick=function(){ endpoint='arrivals';   setTabs(); load(); };

  setTabs(); load(); startAuto();
})();
</script>
</body>
</html>
