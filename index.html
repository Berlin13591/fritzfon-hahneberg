<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BVG Anzeiger – Hahneberg & Reimerweg</title>
<style>
  :root{
    --bvg-yellow:#ffd200;
    --bvg-black:#000;
    --ok:#2e7d32;
    --bad:#c62828;
    --muted:#666;
  }
  html, body{height:100%;}
  body{
    margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji"; 
    background: var(--bvg-black); color:#111;
  }
  .board{
    max-width: 1100px; margin: 0 auto; min-height:100%;
    background: var(--bvg-yellow);
    display:flex; flex-direction:column;
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  header{
    display:flex; align-items:center; justify-content:space-between;
    padding: 16px 18px; position:sticky; top:0; z-index:3;
    background: var(--bvg-yellow);
    border-bottom: 4px solid #111;
  }
  .brand{font-weight:800; letter-spacing:.2px; font-size: 22px;}
  .status{
    font-variant-numeric: tabular-nums;
    font-weight:700; background:#fff; padding:6px 10px; border-radius: 10px;
    border:3px solid #111; min-width: 96px; text-align:center;
  }
  .status.ok{color: var(--ok);}
  .status.bad{color: var(--bad);}
  .tabs, .mode-tabs{
    display:flex; gap:8px; padding: 10px 12px; background:#111; color:#eee;
  }
  .tabs button, .mode-tabs button{
    appearance:none; border:none; padding:10px 14px; border-radius: 10px;
    font-weight:700; cursor:pointer; background:#222; color:#ddd;
    border:2px solid #333;
  }
  .tabs button.active, .mode-tabs button.active{
    background:#fff; color:#111; border-color:#111;
  }
  .ticker{
    display:block; width:100%; overflow:hidden; border-top:4px solid #111; border-bottom:4px solid #111; background:#111; color:#fff;
  }
  .ticker span{
    display:inline-block; padding: 8px 16px; animation: scroll 25s linear infinite;
    white-space:nowrap; font-weight:700; letter-spacing:.3px;
  }
  @keyframes scroll{
    0%{ transform: translateX(100%); }
    100%{ transform: translateX(-100%); }
  }
  table{
    width:100%; border-collapse:collapse; font-size:18px;
  }
  thead th{
    text-align:left; padding:10px 12px; background:#fff; border-bottom:3px solid #111;
    position: sticky; top: 122px; z-index:2;
  }
  tbody td{
    padding:12px; border-bottom:2px solid #111;
    background: #fff;
  }
  .muted{color: var(--muted);}
  .right{text-align:right;}
  .line-badge{
    display:inline-block; min-width:34px; text-align:center; font-weight:800; padding:2px 8px; border-radius: 8px; background:#111; color:#fff;
  }
  footer{
    margin-top:auto; padding: 10px 14px; border-top:4px solid #111; background: #fff8b3;
  }
  .error{ color: var(--bad); font-weight:700; }
  .ghost{ opacity:.6; }
</style>
</head>
<body>
  <div class="board">
    <header>
      <div class="brand">BVG Anzeiger</div>
      <div id="status" class="status ghost">lädt…</div>
    </header>

    <div class="tabs" role="tablist" aria-label="Stationen">
      <button class="active" id="tab-hahneberg" data-stop="900037203">Hahneberg</button>
      <button id="tab-reimerweg" data-stop="900000037274">Reimerweg</button>
    </div>

    <div class="mode-tabs" role="tablist" aria-label="Modus">
      <button class="active" id="tab-dep" data-mode="departures">Abfahrten</button>
      <button id="tab-arr" data-mode="arrivals">Ankünfte</button>
      <button id="tab-refresh" title="Neu laden">⟳</button>
    </div>

    <marquee class="ticker" behavior="scroll" direction="left" scrollamount="5">
      <span id="ticker-text">Willkommen! Nächste Aktualisierung automatisch alle 20&nbsp;Sekunden.</span>
    </marquee>

    <div style="overflow:auto">
      <table aria-live="polite" aria-busy="true">
        <thead>
          <tr>
            <th style="width:10%">Linie</th>
            <th>Ziel</th>
            <th style="width:18%" class="right">Abfahrt</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="3" class="muted">Lade Daten…</td></tr>
        </tbody>
      </table>
    </div>

    <footer>
      <div id="error" class="error" role="alert" aria-live="assertive"></div>
      <div class="muted" style="font-size:14px">
        Live-Daten: BVG / VBB • Anzeige für Hahneberg & Reimerweg
      </div>
    </footer>
  </div>

<script>
const statusEl = document.getElementById('status');
const errorEl  = document.getElementById('error');
const rowsEl   = document.getElementById('rows');
const tickerEl = document.getElementById('ticker-text');

let currentStop = document.querySelector('#tab-hahneberg').dataset.stop;
let currentMode = 'departures';
let timer;

async function fetchWithFallback(stopId, mode){
  const paths = ['stops', 'stations', 'stop-areas'];
  const base = 'https://v5.vbb.transport.rest';
  for(const p of paths){
    const url = `${base}/${p}/${stopId}/${mode}?duration=40&remarks=true&pretty=false`;
    try{
      const res = await fetch(url, {cache:'no-store'});
      if(res.ok){
        const data = await res.json();
        return {status: res.status, ok: true, list: Array.isArray(data) ? data : (data[mode]||[])};
      } else {
        return {status: res.status, ok: false, list: []};
      }
    }catch(e){}
  }
  return {status:'—', ok:false, list:[]};
}

function fmtTime(iso){
  const d = new Date(iso);
  return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}
function minutesFromNow(iso){
  const diff = new Date(iso) - new Date();
  const m = Math.max(0, Math.round(diff/60000));
  return m + ' min';
}
function setStatus(code, ok){
  statusEl.textContent = `HTTP ${code}`;
  statusEl.classList.toggle('ok', ok);
  statusEl.classList.toggle('bad', !ok);
  statusEl.classList.remove('ghost');
}
function renderRows(list){
  if(!list.length){
    rowsEl.innerHTML = `<tr><td colspan="3" class="muted">Keine Einträge.</td></tr>`;
    return;
  }
  list.sort((a,b)=>new Date(a.when||a.plannedWhen)-new Date(b.when||b.plannedWhen));
  rowsEl.innerHTML = list.map(item=>{
    const line = item?.line?.name || '?';
    const dest = item?.direction || '—';
    const when = item?.plannedWhen || item?.when;
    const delayMin = item?.delay ? Math.round(item.delay/60) : 0;
    const delayTxt = delayMin ? ` (+${delayMin})` : '';
    return `<tr>
      <td><span class="line-badge">${line}</span></td>
      <td>${dest}</td>
      <td class="right"><strong>${fmtTime(when)}</strong> <span class="muted">(${minutesFromNow(when)})</span>${delayTxt}</td>
    </tr>`;
  }).join('');
}

async function fetchAndRender(){
  clearTimeout(timer);
  errorEl.textContent = '';
  rowsEl.innerHTML = `<tr><td colspan="3" class="muted">Lade Daten…</td></tr>`;
  statusEl.classList.add('ghost');

  const {status, ok, list} = await fetchWithFallback(currentStop, currentMode);
  setStatus(status, ok);

  if(!ok){
    rowsEl.innerHTML = `<tr><td colspan="3" class="muted">Keine Daten (API-Fehler)</td></tr>`;
    errorEl.textContent = 'Fehler beim Laden der Live-Daten';
  } else {
    renderRows(list);
    tickerEl.textContent = `${list.length} Einträge • Aktualisiert: ${new Date().toLocaleTimeString()}`;
  }

  timer = setTimeout(fetchAndRender, 20000);
}

document.querySelectorAll('.tabs button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentStop = btn.dataset.stop;
    fetchAndRender();
  });
});
document.querySelectorAll('.mode-tabs button[data-mode]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.mode-tabs button[data-mode]').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentMode = btn.dataset.mode;
    document.querySelector('thead th.right').textContent =
      currentMode === 'arrivals' ? 'Ankunft' : 'Abfahrt';
    fetchAndRender();
  });
});
document.getElementById('tab-refresh').addEventListener('click', fetchAndRender);

fetchAndRender();
</script>
</body>
</html>
