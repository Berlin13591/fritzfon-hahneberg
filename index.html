<script>
(() => {
  // ---- Settings ----
  const BASES = ['https://v6.vbb.transport.rest']; // kannst du um 'https://v5.vbb.transport.rest' erweitern
  const PATHS = ['stops', 'stations']; // erst /stops, dann /stations

  // Feste Stop-IDs
  const STOP_HAHNEBERG = '900037203';
  const STOP_REIMERWEG = '900000037274';

  // UI refs
  const listEl   = document.getElementById('list');
  const errEl    = document.getElementById('err');
  const statusEl = document.getElementById('status');
  const badge    = document.getElementById('badge');
  const clock    = document.getElementById('clock');

  const tHahneberg = document.getElementById('tHahneberg');
  const tReimerweg = document.getElementById('tReimerweg');
  const tDeps = document.getElementById('tDeps');
  const tArrs = document.getElementById('tArrs');

  let stopMode = 'hahneberg';      // 'hahneberg' | 'reimerweg'
  let endpoint = 'departures';     // 'departures' | 'arrivals'
  let lineSet  = new Set(['M37','M49']); // initial

  // Uhr unten rechts
  setInterval(() => {
    clock.textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }, 1000);

  function setTabs() {
    tHahneberg.classList.toggle('active', stopMode==='hahneberg');
    tReimerweg.classList.toggle('active', stopMode==='reimerweg');
    tDeps.classList.toggle('active', endpoint==='departures');
    tArrs.classList.toggle('active', endpoint==='arrivals');
  }

  tHahneberg.onclick = () => { stopMode='hahneberg'; lineSet=new Set(['M37','M49']); setTabs(); load(); };
  tReimerweg.onclick = () => { stopMode='reimerweg'; lineSet=new Set(['M137','137']); setTabs(); load(); };
  tDeps.onclick = () => { endpoint='departures'; setTabs(); load(); };
  tArrs.onclick = () => { endpoint='arrivals'; setTabs(); load(); };

  // ---- helpers ----
  const minutesLeft = (iso) => Math.max(0, Math.round((new Date(iso).getTime() - Date.now())/60000));
  function makeLineBadge(line){ const d=document.createElement('div'); d.className='badgeLine'; d.textContent=line; return d; }
  function applyTicker(container, inner){
    const wCont=container.clientWidth, wInner=inner.scrollWidth;
    inner.style.transform='translateX(0)';
    if(wInner<=wCont){ inner.style.animation='none'; return; }
    const gap=60, text=inner.textContent, total=wInner+gap, key='marq_'+Math.random().toString(36).slice(2);
    inner.innerHTML=`<span>${text}</span><span style="padding-left:${gap}px">${text}</span>`;
    const st=document.createElement('style'); st.textContent=`@keyframes ${key}{0%{transform:translateX(0)}100%{transform:translateX(-${total}px)}}`; document.head.appendChild(st);
    inner.style.willChange='transform'; inner.style.animation=`${key} ${Math.max(8, Math.round(total/60))}s linear infinite`;
  }
  function makeRow(d){
    const row=document.createElement('div'); row.className='row';
    const lin=document.createElement('div'); lin.className='lincol'; lin.appendChild(makeLineBadge(d?.line?.name||'')); 
    const dirWrap=document.createElement('div'); dirWrap.className='dir';
    const dirInner=document.createElement('div'); dirInner.className='tickerInner';
    dirInner.textContent=(d.direction||'').replace(/^Berlin,\s*/,'').trim();
    dirWrap.appendChild(dirInner);
    const mins=document.createElement('div'); mins.className='mins';
    const t=d.when||d.plannedWhen; mins.innerHTML=`${minutesLeft(t)}<span class="unit">min</span>`;
    row.appendChild(lin); row.appendChild(dirWrap); row.appendChild(mins);
    requestAnimationFrame(()=>applyTicker(dirWrap, dirInner));
    return row;
  }
  function render(list){
    listEl.innerHTML=''; errEl.style.display='none';
    if(!list.length){ const r=document.createElement('div'); r.className='row'; r.style.justifyContent='center';
      r.innerHTML=`<div style="grid-column:1/4;text-align:center;font-weight:900">Keine Daten</div>`; listEl.appendChild(r); return; }
    list.forEach(d=>listEl.appendChild(makeRow(d)));
  }

  // ---- Robust fetch: try /stops then /stations (avoids 404 on some modes/IDs) ----
  async function fetchList(stopId, endpoint){
    const qs = 'duration=180&results=120&language=de&remarks=false';
    let lastUrl='', lastStatus='—', lastErr=null;
    for(const base of BASES){
      for(const path of PATHS){
        const url = `${base}/${path}/${encodeURIComponent(stopId)}/${endpoint}?${qs}`;
        lastUrl=url;
        try{
          const res = await fetch(url, {headers:{accept:'application/json'}, cache:'no-store'});
          lastStatus = res.status;
          if(res.ok){ const data = await res.json(); return { ok:true, status:lastStatus, url, list: Array.isArray(data)? data : (data && data[endpoint] || []) }; }
          // nicht ok → nächsten Pfad probieren
        }catch(e){ lastErr=e; /* nächster Pfad */ }
      }
    }
    if(lastErr) console.error('Fetch error:', lastErr);
    return { ok:false, status:lastStatus, url:lastUrl, list:[] };
  }

  async function load(){
    statusEl.textContent='lädt…';
    listEl.innerHTML='';
    const stopId = (stopMode==='hahneberg') ? STOP_HAHNEBERG : STOP_REIMERWEG;

    const {ok, status, url, list} = await fetchList(stopId, endpoint);
    statusEl.textContent = `HTTP ${status}` + (ok ? '' : ' • Fehler');

    if(!ok){
      render([]);
      errEl.textContent = `Fehler: HTTP ${status} • ${url}`;
      errEl.style.display = 'block';
      return;
    }

    // Linien filtern und anzeigen
    const filtered = list
      .filter(d => lineSet.has(String(d?.line?.name || '').toUpperCase()))
      .sort((a,b)=> new Date(a.when||a.plannedWhen) - new Date(b.when||b.plannedWhen))
      .slice(0, 18);

    render(filtered);
    statusEl.textContent = `HTTP ${status} • aktualisiert ${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
  }

  // Auto-Refresh + Countdown
  let cd=30, timerR=null, timerC=null;
  function startAuto(){
    if(timerR) clearInterval(timerR);
    if(timerC) clearInterval(timerC);
    cd=30; badge.textContent=cd+'s';
    timerC=setInterval(()=>{ cd--; if(cd<0) cd=30; badge.textContent=cd+'s'; },1000);
    timerR=setInterval(()=>{ cd=30; load(); },30000);
  }

  setTabs(); load(); startAuto();
})();
</script>
