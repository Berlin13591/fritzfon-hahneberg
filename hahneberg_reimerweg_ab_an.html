<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Hahneberg â€“ M37/M49</title>
  <style>
    :root { color-scheme: light dark; --fg:#111; --bg:#fff; --muted:#666; --accent:#0a7; }
    .dark { --fg:#f5f5f5; --bg:#000; --muted:#aaa; --accent:#6fd; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; }
    .wrap { max-width: 560px; margin: 0 auto; padding: 10px 12px 24px; }
    h1 { font-size: 22px; margin: 6px 0 10px; font-weight: 800; }
    .meta { font-size: 12px; color: var(--muted); display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .row { display:flex; align-items: center; justify-content: space-between; padding: 12px 10px; border-radius: 12px; margin: 8px 0; background: rgba(127,127,127,0.08); }
    .line { font-weight: 800; font-size: 18px; min-width: 56px; text-align: left; }
    .dir { font-size: 14px; line-height: 1.2; flex: 1 1 auto; padding: 0 8px; }
    .mins { font-size: 22px; font-weight: 800; min-width: 56px; text-align: right; }
    .badge { font-size: 11px; padding: 2px 6px; border-radius: 999px; background: var(--accent); color: #002; font-weight: 800; margin-left:6px; }
    .small { font-size: 12px; color: var(--muted); }
    input, button { font-size: 14px; border-radius: 10px; border: 1px solid rgba(127,127,127,0.35); padding: 6px 10px; background: transparent; color: var(--fg); }
    button { cursor: pointer; }
    .error { color: #b00020; font-size: 13px; margin-top: 8px; }
    .hidden { display: none; }
    .nav, .subnav { display:flex; justify-content:center; gap:8px; margin: 10px 0; }
    .nav button, .subnav button { padding: 6px 12px; border-radius: 12px; border: none; background: rgba(127,127,127,0.15); color: var(--fg); font-weight: 600; }
    .nav button.active, .subnav button.active { background: var(--accent); color: #002; }
    .controls { display:flex; justify-content: space-between; align-items:center; margin: 6px 0 8px; }
    .summary { font-size: 13px; }
    .toggle { border: 1px solid rgba(127,127,127,0.35); border-radius: 12px; padding: 4px 8px; }
    .sectionTitle { font-size: 14px; font-weight: 700; color: var(--muted); margin-top: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="controls">
      <h1 id="title" style="margin:0;">Hahneberg â€“ M37/M49</h1>
      <button id="themeBtn" class="toggle" title="Hell/Dunkel umschalten">ðŸŒ™</button>
    </div>
    <div class="meta">
      <span id="status">lÃ¤dtâ€¦</span>
      <span class="badge" id="refreshBadge">30s</span>
      <span id="nextInfo" class="summary"></span>
    </div>

    <div class="nav">
      <button id="btnHahneberg" class="active">Hahneberg</button>
      <button id="btnReimerweg">Reimerweg</button>
    </div>

    <div class="subnav">
      <button id="btnDepartures" class="active">Abfahrten</button>
      <button id="btnArrivals">AnkÃ¼nfte</button>
    </div>

    <div id="list"></div>
    <div id="error" class="error hidden"></div>
  </div>

<script>
(function(){
  const API_BASE = 'https://v6.vbb.transport.rest';
  const statusEl = document.getElementById('status');
  const listEl = document.getElementById('list');
  const errEl = document.getElementById('error');
  const refreshBadge = document.getElementById('refreshBadge');
  const btnHahneberg = document.getElementById('btnHahneberg');
  const btnReimerweg = document.getElementById('btnReimerweg');
  const btnDepartures = document.getElementById('btnDepartures');
  const btnArrivals = document.getElementById('btnArrivals');
  const titleEl = document.getElementById('title');
  const nextInfoEl = document.getElementById('nextInfo');
  const themeBtn = document.getElementById('themeBtn');

  let stopQuery = 'Hahneberg';
  let lines = new Set(['M37','M49']);
  let view = 'departures'; // or 'arrivals'
  let refreshTimer = null;
  let countdownTimer = null;
  let countdown = 30;

  // THEME
  function applyTheme(theme){
    document.documentElement.classList.toggle('dark', theme === 'dark');
    localStorage.setItem('theme', theme);
    themeBtn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
  }
  const savedTheme = localStorage.getItem('theme');
  if(savedTheme){ applyTheme(savedTheme); }
  themeBtn.addEventListener('click', ()=>{
    const next = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
    applyTheme(next);
  });

  function mins(until){
    const dt = new Date(until).getTime();
    const diff = Math.max(0, Math.round((dt - Date.now())/60000));
    return diff;
  }

  async function resolveStop(query){
    const url = `${API_BASE}/locations?query=${encodeURIComponent(query)}&stops=true&results=5`;
    const res = await fetch(url, { headers: { 'accept': 'application/json' }, cache: 'no-store' });
    if(!res.ok) throw new Error('Stop-Suche fehlgeschlagen (HTTP ' + res.status + ')');
    const data = await res.json();
    const stop = data.find(x => x.type === 'stop');
    if(!stop) throw new Error('Keine Haltestelle gefunden');
    return stop.id;
  }

  function render(deps){
    listEl.innerHTML = '';
    if(!deps || !deps.length){
      listEl.innerHTML = '<div class="small">Keine ' + (view==='departures'?'Abfahrten':'AnkÃ¼nfte') + ' in den nÃ¤chsten 90 Minuten.</div>';
      nextInfoEl.textContent = '';
      return;
    }
    // Summary (erste Zeile)
    const first = deps[0];
    const when = first?.when || first?.plannedWhen;
    const m = mins(when);
    const line = first?.line?.name || '';
    const label = view==='departures' ? 'NÃ¤chste Abfahrt' : 'NÃ¤chste Ankunft';
    nextInfoEl.textContent = `${label}: ${line} in ${m} min (um ${new Date(when).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})})`;

    deps.forEach(d => {
      const line = d?.line?.name || '';
      const dir = d?.direction || '';
      const when = d?.when || d?.plannedWhen;
      const delayMin = (d?.delay || 0)/60;
      const m = mins(when);
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `
        <div class="line">${line}</div>
        <div class="dir">${dir}<div class="small">${new Date(when).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}${delayMin?` â€¢ Â±${delayMin} min`:''}</div></div>
        <div class="mins">${m}<span class="small"> min</span></div>
      `;
      listEl.appendChild(row);
    });
  }

  async function load(){
    try{
      statusEl.textContent = 'lÃ¤dtâ€¦';
      errEl.classList.add('hidden');
      const stopId = await resolveStop(stopQuery);
      const endpoint = view === 'departures' ? 'departures' : 'arrivals';
      const url = `${API_BASE}/stops/${encodeURIComponent(stopId)}/${endpoint}?duration=90&results=50&language=de&remarks=false`;
      const res = await fetch(url, { headers: { 'accept': 'application/json' }, cache: 'no-store' });
      const data = await res.json();
      const list = Array.isArray(data) ? data : (data && Array.isArray(data[endpoint]) ? data[endpoint] : []);
      const filtered = list.filter(d => {
        const name = (d?.line?.name || '').toUpperCase();
        return lines.has(name);
      }).slice(0, 20);
      render(filtered);
      statusEl.textContent = `${stopQuery} â€¢ ${view==='departures'?'Abfahrten':'AnkÃ¼nfte'} â€¢ aktualisiert ${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
    }catch(e){
      console.error(e);
      errEl.textContent = e.message || String(e);
      errEl.classList.remove('hidden');
      statusEl.textContent = 'Fehler';
      nextInfoEl.textContent = '';
    }
  }

  function startAutoRefresh(){
    if(refreshTimer) clearInterval(refreshTimer);
    if(countdownTimer) clearInterval(countdownTimer);
    countdown = 30;
    refreshBadge.textContent = countdown + 's';
    countdownTimer = setInterval(()=>{
      countdown--; if(countdown<0) countdown=30; refreshBadge.textContent = countdown + 's';
    }, 1000);
    refreshTimer = setInterval(()=>{ countdown=30; load(); }, 30000);
  }

  function setMode(mode){
    if(mode==='hahneberg'){
      stopQuery = 'Hahneberg';
      lines = new Set(['M37','M49']);
      titleEl.textContent = 'Hahneberg â€“ M37/M49';
      document.title = 'Hahneberg â€“ M37/M49';
      btnHahneberg.classList.add('active');
      btnReimerweg.classList.remove('active');
    } else {
      stopQuery = 'Reimerweg';
      lines = new Set(['M137','137']); // M137 oder 137
      titleEl.textContent = 'Reimerweg â€“ M137';
      document.title = 'Reimerweg â€“ M137';
      btnReimerweg.classList.add('active');
      btnHahneberg.classList.remove('active');
    }
    localStorage.setItem('mode', mode);
    load();
  }

  function setView(v){
    view = v;
    localStorage.setItem('view', v);
    if(v==='departures'){
      btnDepartures.classList.add('active');
      btnArrivals.classList.remove('active');
    } else {
      btnArrivals.classList.add('active');
      btnDepartures.classList.remove('active');
    }
    load();
  }

  btnHahneberg.addEventListener('click', ()=> setMode('hahneberg'));
  btnReimerweg.addEventListener('click', ()=> setMode('reimerweg'));
  btnDepartures.addEventListener('click', ()=> setView('departures'));
  btnArrivals.addEventListener('click', ()=> setView('arrivals'));

  // initial: gespeicherten Modus/Ansicht/Theme anwenden
  const savedMode = localStorage.getItem('mode') || 'hahneberg';
  const savedView = localStorage.getItem('view') || 'departures';
  setMode(savedMode);
  setView(savedView);
  startAutoRefresh();
})();
</script>
</body>
</html>