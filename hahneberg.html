<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Hahneberg – M37/M49</title>
  <style>
    :root {
      color-scheme: light dark;
      --fg: #111;
      --bg: #fff;
      --muted: #666;
      --accent: #0a7;
    }
    @media (prefers-color-scheme: dark) {
      :root { --fg:#f5f5f5; --bg:#000; --muted:#aaa; --accent:#6fd; }
    }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; }
    .wrap { max-width: 420px; margin: 0 auto; padding: 8px 10px 20px; }
    h1 { font-size: 20px; margin: 4px 0 8px; font-weight: 700; }
    .meta { font-size: 12px; color: var(--muted); display:flex; gap:8px; align-items:center; }
    .row { display:flex; align-items: center; justify-content: space-between; padding: 10px 8px; border-radius: 12px; margin: 6px 0; background: rgba(127,127,127,0.08); }
    .line { font-weight: 800; font-size: 18px; min-width: 56px; text-align: left; }
    .dir { font-size: 14px; line-height: 1.2; flex: 1 1 auto; padding: 0 8px; }
    .mins { font-size: 22px; font-weight: 800; min-width: 56px; text-align: right; }
    .badge { font-size: 11px; padding: 2px 6px; border-radius: 999px; background: var(--accent); color: #002; font-weight: 800; margin-left:6px; }
    .small { font-size: 12px; color: var(--muted); }
    .topbar { display:flex; gap:6px; align-items:center; margin-bottom:8px; }
    input, button, select { font-size: 14px; border-radius: 10px; border: 1px solid rgba(127,127,127,0.35); padding: 6px 10px; background: transparent; color: var(--fg); }
    button { cursor: pointer; }
    .hint { font-size: 12px; color: var(--muted); margin-top: 6px; }
    .error { color: #b00020; font-size: 13px; margin-top: 8px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Hahneberg – M37/M49</h1>
    <div class="meta">
      <span id="status">lädt…</span>
      <span class="badge" id="refreshBadge">30s</span>
    </div>

    <div class="topbar">
      <input id="stopInput" placeholder="Haltestelle oder Stop-ID" autocomplete="off" aria-label="Haltestelle" />
      <button id="applyBtn" title="Übernehmen">OK</button>
    </div>
    <div class="hint">Tipp: Leer lassen = „Hahneberg“. Du kannst auch direkt eine Stop-ID wie <code>900000231001</code> eingeben.</div>

    <div id="list"></div>
    <div id="error" class="error hidden"></div>
    <div class="small" id="foot"></div>
  </div>

<script>
(function(){
  const API_BASE = 'https://v6.vbb.transport.rest';
  const LINES = new Set(['M37','M49']);
  const statusEl = document.getElementById('status');
  const listEl = document.getElementById('list');
  const errEl = document.getElementById('error');
  const footEl = document.getElementById('foot');
  const inputEl = document.getElementById('stopInput');
  const applyBtn = document.getElementById('applyBtn');
  const refreshBadge = document.getElementById('refreshBadge');

  let stopId = '';
  let stopName = '';
  let refreshTimer = null;
  let countdownTimer = null;
  let countdown = 30;

  function qs(name){
    const u = new URL(location.href);
    return u.searchParams.get(name) || '';
  }
  function setQS(obj){
    const u = new URL(location.href);
    Object.entries(obj).forEach(([k,v])=>{
      if(v) u.searchParams.set(k,v); else u.searchParams.delete(k);
    });
    history.replaceState(null, '', u.toString());
  }

  async function resolveStop(q){
    if(/^[0-9]{9,}$/.test(q)) return { id: q, name: '' };
    const query = (q || 'Hahneberg');
    const url = `${API_BASE}/locations?query=${encodeURIComponent(query)}&stops=true&results=5`;
    const res = await fetch(url, { headers: { 'accept': 'application/json' }, cache: 'no-store' });
    if(!res.ok) throw new Error('Stop-Suche fehlgeschlagen (HTTP ' + res.status + ')');
    let data; let raw = null;
    const ct = (res.headers.get('content-type')||'').toLowerCase();
    if (ct.includes('application/json')) {
      data = await res.json();
    } else {
      raw = await res.text();
      try { data = JSON.parse(raw); } catch { data = raw; }
    }
    const stop = Array.isArray(data) ? data.find(x => x.type==='stop') : null;
    if(!stop) throw new Error('Keine Haltestelle gefunden');
    return { id: stop.id, name: stop.name };
  }

  function mins(until){
    const dt = new Date(until).getTime();
    const diff = Math.max(0, Math.round((dt - Date.now())/60000));
    return diff;
  }

  function render(deps){
    listEl.innerHTML = '';
    if(!deps || !deps.length){
      listEl.innerHTML = '<div class="small">Keine Abfahrten in den nächsten 60 Minuten.</div>';
      return;
    }
    deps.forEach(d => {
      const line = d?.line?.name || '';
      const dir = d?.direction || '';
      const when = d?.when || d?.plannedWhen;
      const delayMin = (d?.delay || 0)/60;
      const m = mins(when);
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `
        <div class="line">${line}</div>
        <div class="dir">${dir}<div class="small">${(d.platform?('Gleis ' + d.platform + ' • '):'')}${new Date(when).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}${delayMin?` • ±${delayMin} min`:''}</div></div>
        <div class="mins">${m}<span class="small"> min</span></div>
      `;
      listEl.appendChild(row);
    });
  }

  async function load(){
    try {
      statusEl.textContent = 'lädt…';
      errEl.classList.add('hidden');
      const q = inputEl.value.trim();
      const stop = await resolveStop(q);
      stopId = stop.id; stopName = stop.name || 'Hahneberg';
      setQS({ id: stopId });

      const url = `${API_BASE}/stops/${encodeURIComponent(stopId)}/departures?duration=60&results=50&language=de&remarks=false`;
      const res = await fetch(url, { headers: { 'accept': 'application/json' }, cache: 'no-store', mode: 'cors' });
      if(!res.ok){
        let t='';
        try{ t = await res.text(); }catch{}
        throw new Error(`Abfahrten nicht abrufbar (HTTP ${res.status})${t?`: ${t.slice(0,140)}`:''}`);
      }
      let data; let raw = null;
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      if (ct.includes('application/json')) {
        data = await res.json();
      } else {
        raw = await res.text();
        try { data = JSON.parse(raw); } catch { data = raw; }
      }
      const deps = Array.isArray(data) ? data : (data && Array.isArray(data.departures) ? data.departures : []);
      if (!Array.isArray(deps)) throw new Error('Unerwartetes Antwortformat');
      const filtered = deps.filter(d => LINES.has((d?.line?.name||'').toUpperCase())).slice(0, 20);
      render(filtered);
      statusEl.textContent = `${stopName} • aktualisiert ${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
    } catch(e){
      console.error(e);
      errEl.textContent = e.message || String(e);
      errEl.classList.remove('hidden');
      statusEl.textContent = 'Fehler';
    }
  }

  function startAutoRefresh(){
    if(refreshTimer) clearInterval(refreshTimer);
    if(countdownTimer) clearInterval(countdownTimer);
    countdown = 30;
    refreshBadge.textContent = countdown + 's';
    countdownTimer = setInterval(()=>{
      countdown--; if(countdown<0) countdown=30; refreshBadge.textContent = countdown + 's';
    }, 1000);
    refreshTimer = setInterval(()=>{ countdown=30; load(); }, 30000);
  }

  applyBtn.addEventListener('click', ()=>{ load(); startAutoRefresh(); });
  inputEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ load(); startAutoRefresh(); }});

  (function init(){
    const presetId = qs('id');
    if(presetId) inputEl.value = presetId;
    load().then(startAutoRefresh);
  })();
})();
</script>
</body>
</html>
